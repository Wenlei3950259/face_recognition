# 依赖说明

## 完整依赖列表

本项目的所有依赖都在 `requirements.txt` 文件中定义。

### 依赖分类

#### 1. FastAPI 相关（异步改造新增）
```
fastapi==0.109.0              # Web 框架
uvicorn[standard]==0.27.0     # ASGI 服务器
python-multipart==0.0.6       # 文件上传支持
slowapi==0.1.9                # 异步限流
aiofiles==23.2.1              # 异步文件操作
```

#### 2. 人脸识别核心
```
insightface==0.7.3            # 人脸识别库
onnx==1.17.0                  # ONNX 模型支持
onnxruntime==1.19.0           # ONNX 运行时
```

#### 3. 数据处理
```
numpy==1.23.5                 # 数值计算
torch==2.0.1                  # 深度学习框架
opencv-python==4.8.0.76       # 图像处理
```

#### 4. 其他工具
```
pymysql==1.0.2                # MySQL 数据库连接
PyYAML==6.0                   # YAML 配置文件解析
```

## 安装方式

### 完整安装（推荐）

**首次部署或全新环境**，需要安装所有依赖：

```bash
# 使用国内镜像加速
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt

# 或使用默认源
pip install -r requirements.txt
```

### 增量安装（仅适用于已有环境）

如果你的环境已经安装了 InsightFace 等基础依赖，只需要安装 FastAPI 相关的新增依赖：

```bash
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple \
    fastapi==0.109.0 \
    uvicorn[standard]==0.27.0 \
    python-multipart==0.0.6 \
    slowapi==0.1.9 \
    aiofiles==23.2.1
```

**注意**：增量安装仅适用于从 Flask 版本升级的情况。

## 依赖大小

| 类别 | 大小（约） | 说明 |
|------|-----------|------|
| FastAPI 相关 | ~50MB | 轻量级 Web 框架 |
| InsightFace | ~500MB | 包含预训练模型 |
| PyTorch | ~800MB | 深度学习框架 |
| OpenCV | ~100MB | 图像处理库 |
| 其他 | ~50MB | 工具库 |
| **总计** | **~1.5GB** | 首次安装需要时间 |

## 安装时间估算

| 网络环境 | 预计时间 |
|---------|---------|
| 国内（使用镜像） | 5-10 分钟 |
| 国内（不使用镜像） | 15-30 分钟 |
| 国外 | 3-5 分钟 |

## 常见问题

### Q1: 为什么要安装完整的 requirements.txt？

**A**: 虽然异步改造只新增了 FastAPI 相关的包，但在全新环境部署时，需要安装所有依赖才能正常运行。包括：
- InsightFace 人脸识别核心
- PyTorch 深度学习框架
- OpenCV 图像处理
- 其他工具库

### Q2: 我已经有旧环境，只想升级到异步版本怎么办？

**A**: 如果你的环境已经运行过 Flask 版本，只需要安装 FastAPI 相关的新增依赖：

```bash
pip install fastapi uvicorn[standard] python-multipart slowapi aiofiles
```

### Q3: 安装失败怎么办？

**A**: 常见解决方案：

1. **使用国内镜像**
```bash
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt
```

2. **更新 pip**
```bash
pip install --upgrade pip
```

3. **分步安装**
```bash
# 先安装基础依赖
pip install numpy opencv-python PyYAML pymysql

# 再安装深度学习相关
pip install torch onnx onnxruntime

# 安装 InsightFace
pip install insightface

# 最后安装 FastAPI
pip install fastapi uvicorn[standard] python-multipart slowapi aiofiles
```

### Q4: PyTorch 安装太慢怎么办？

**A**: PyTorch 比较大，可以使用清华镜像：

```bash
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple torch==2.0.1
```

或访问 PyTorch 官网选择合适的安装命令：https://pytorch.org/

### Q5: 是否需要 GPU 版本的依赖？

**A**: 默认使用 CPU 版本。如果需要 GPU 加速：

1. 安装 CUDA 和 cuDNN
2. 安装 GPU 版本的 PyTorch
3. 安装 onnxruntime-gpu
4. 修改配置文件使用 CUDAExecutionProvider

## 版本兼容性

### Python 版本
- **推荐**: Python 3.8
- **支持**: Python 3.7 - 3.10
- **不支持**: Python 3.6 及以下、Python 3.11 及以上

### 操作系统
- ✅ Windows 10/11
- ✅ Ubuntu 18.04+
- ✅ CentOS 7+
- ✅ macOS 10.14+

## 依赖更新

### 检查过时的包
```bash
pip list --outdated
```

### 更新单个包
```bash
pip install --upgrade <包名>
```

### 更新所有包（不推荐）
```bash
pip install --upgrade -r requirements.txt
```

**注意**：不建议随意更新依赖版本，可能导致兼容性问题。

## 虚拟环境建议

### 使用 Conda（推荐）
```bash
# 创建环境
conda create -n face_mobile_recognition python=3.8

# 激活环境
conda activate face_mobile_recognition

# 安装依赖
pip install -r requirements.txt
```

### 使用 venv
```bash
# 创建环境
python -m venv venv

# 激活环境（Windows）
venv\Scripts\activate

# 激活环境（Linux/Mac）
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

## 依赖冲突解决

如果遇到依赖冲突，可以尝试：

1. **创建全新的虚拟环境**
2. **使用 pip-tools 管理依赖**
3. **逐个安装依赖，找出冲突的包**

## 生产环境建议

1. **固定版本号**: requirements.txt 中已固定版本，避免意外更新
2. **使用私有 PyPI 镜像**: 提高安装速度和稳定性
3. **Docker 镜像**: 预先构建包含所有依赖的 Docker 镜像
4. **离线安装**: 下载 wheel 文件，离线安装

---

**总结**：首次部署请使用 `pip install -r requirements.txt` 安装完整依赖！
